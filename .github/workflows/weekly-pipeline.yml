name: Weekly Prediction Pipeline

on:
  schedule:
    # Tuesday 06:00 UTC - Ingest + Research + Predict + Report
    - cron: '0 6 * * 2'
    # Sunday 22:00 UTC - Evaluate results
    - cron: '0 22 * * 0'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Pipeline mode'
        required: true
        default: 'predict'
        type: choice
        options:
          - predict
          - evaluate
          - full

env:
  SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mypredictify/package-lock.json

      - name: Install dependencies
        working-directory: mypredictify
        run: npm ci

      - name: Determine pipeline mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "mode=${{ inputs.mode }}" >> $GITHUB_OUTPUT
          elif [ "$(date +%u)" = "2" ]; then
            echo "mode=predict" >> $GITHUB_OUTPUT
          else
            echo "mode=evaluate" >> $GITHUB_OUTPUT
          fi

      - name: Setup Claude CLI
        run: |
          # Install Claude CLI (adjust based on actual availability)
          npm install -g @anthropic-ai/claude-code || echo "Claude CLI not available in CI - using direct script execution"

      - name: Run prediction pipeline
        if: steps.mode.outputs.mode == 'predict' || steps.mode.outputs.mode == 'full'
        working-directory: mypredictify
        run: |
          # Direct script execution fallback if Claude CLI unavailable
          echo "Running prediction pipeline..."

          # Step 1: Ingest
          echo "=== INGEST ==="
          for league_id in 8 564 82 384 301; do
            echo "Fetching fixtures for league $league_id..."
            npx tsx scripts/fetch-sportmonks.ts fixtures --league $league_id > /tmp/fixtures_${league_id}.json 2>&1 || echo "Warning: Failed to fetch league $league_id"
          done

          # Steps 2-4 require Claude CLI for research/prediction/report
          # If Claude CLI is available:
          # claude -p "run /run-pipeline --mode predict"

          echo "Pipeline predict mode complete (data ingestion done)"

      - name: Run evaluation pipeline
        if: steps.mode.outputs.mode == 'evaluate' || steps.mode.outputs.mode == 'full'
        working-directory: mypredictify
        run: |
          echo "Running evaluation pipeline..."

          # Fetch results
          for league_id in 8 564 82 384 301; do
            echo "Fetching results for league $league_id..."
            npx tsx scripts/fetch-sportmonks.ts results --league $league_id > /tmp/results_${league_id}.json 2>&1 || echo "Warning: Failed to fetch results for league $league_id"
          done

          # If Claude CLI is available:
          # claude -p "run /run-pipeline --mode evaluate"

          echo "Pipeline evaluate mode complete"

      - name: Commit and push changes
        working-directory: mypredictify
        run: |
          git config user.name "MyPredictify Pipeline"
          git config user.email "pipeline@mypredictify.com"

          # Stage all data changes
          git add data/ || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            MODE="${{ steps.mode.outputs.mode }}"
            git commit -m "Pipeline: ${MODE} run $(date +%Y-%m-%d)"
            git push
          fi

      - name: Report status
        if: always()
        run: |
          echo "Pipeline completed with status: ${{ job.status }}"
          echo "Mode: ${{ steps.mode.outputs.mode }}"
          # Could add Slack/email notification here
