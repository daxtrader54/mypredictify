name: Daily Prediction Pipeline

on:
  schedule:
    # Daily at 08:00 UTC
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (detect only, no execution)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  SPORTMONKS_API_TOKEN: ${{ secrets.SPORTMONKS_API_TOKEN }}
  SEASON: '2025-26'

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mypredictify/package-lock.json

      - name: Install dependencies
        working-directory: mypredictify
        run: npm ci

      - name: Run pipeline orchestrator
        id: pipeline
        working-directory: mypredictify
        run: |
          DRY_RUN_FLAG=""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          npx tsx scripts/pipeline-cron.ts --season "$SEASON" $DRY_RUN_FLAG | tee /tmp/pipeline-output.txt

          # Parse status file for downstream steps
          if [ -f pipeline-status.json ]; then
            ACTION_COUNT=$(node -e "const s=require('./pipeline-status.json'); console.log(s.actions.length)")
            HAS_CHANGES=$(node -e "const s=require('./pipeline-status.json'); console.log(s.actions.some(a => a.status === 'success') ? 'true' : 'false')")
            SUMMARY=$(node -e "const s=require('./pipeline-status.json'); console.log(s.summary)")
            AFFECTED_GWS=$(node -e "const s=require('./pipeline-status.json'); console.log(s.actions.filter(a=>a.status==='success').map(a=>a.gameweek).join(','))")

            echo "action_count=$ACTION_COUNT" >> $GITHUB_OUTPUT
            echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
            echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
            echo "affected_gws=$AFFECTED_GWS" >> $GITHUB_OUTPUT
          else
            echo "action_count=0" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "summary=No status file produced" >> $GITHUB_OUTPUT
            echo "affected_gws=" >> $GITHUB_OUTPUT
          fi

      - name: Commit data changes
        if: steps.pipeline.outputs.has_changes == 'true' && inputs.dry_run != 'true'
        working-directory: mypredictify
        run: |
          git config user.name "MyPredictify Pipeline"
          git config user.email "pipeline@mypredictify.com"

          # Stage data and memory files only
          git add data/gameweeks/ data/memory/ || true

          if git diff --staged --quiet; then
            echo "No file changes to commit"
          else
            git commit -m "Pipeline: auto-run $(date -u +%Y-%m-%d) — ${{ steps.pipeline.outputs.summary }}"
            git push
            echo "Changes committed and pushed"
          fi

      - name: Sync to production database
        if: steps.pipeline.outputs.has_changes == 'true' && inputs.dry_run != 'true' && env.APP_URL != ''
        env:
          APP_URL: ${{ secrets.APP_URL }}
          PIPELINE_SYNC_KEY: ${{ secrets.PIPELINE_SYNC_KEY }}
        working-directory: mypredictify
        run: |
          IFS=',' read -ra GWS <<< "${{ steps.pipeline.outputs.affected_gws }}"
          for gw in "${GWS[@]}"; do
            if [ -z "$gw" ]; then continue; fi
            echo "Syncing $gw to production..."
            HTTP_CODE=$(curl -s -o /tmp/sync-response.txt -w "%{http_code}" \
              -X POST "${APP_URL}/api/pipeline/sync" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${PIPELINE_SYNC_KEY}" \
              -d "{\"season\": \"${SEASON}\", \"gameweek\": \"${gw}\"}")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "  ✓ $gw synced successfully"
            else
              echo "  ✗ $gw sync failed (HTTP $HTTP_CODE)"
              cat /tmp/sync-response.txt
            fi
          done

      - name: Write job summary
        if: always()
        run: |
          echo "## Pipeline Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $(date -u +%Y-%m-%d\ %H:%M\ UTC)" >> $GITHUB_STEP_SUMMARY
          echo "- **Season:** $SEASON" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry run:** ${{ inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actions:** ${{ steps.pipeline.outputs.action_count || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Result:** ${{ steps.pipeline.outputs.summary || 'No output' }}" >> $GITHUB_STEP_SUMMARY

          if [ -f mypredictify/pipeline-status.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Details" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat mypredictify/pipeline-status.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
